<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Timeless One-Page HTML Template</title>
    <!-- 

Timeless Template 

http://www.templatemo.com/tm-517-timeless

-->
    <!-- load CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,400">
    <!-- Google web font "Open Sans" -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- https://getbootstrap.com/ -->
    <link rel="stylesheet" href="css/templatemo-style.css">
    <!-- Templatemo style -->
</head>

<body>

    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <header class="text-center tm-site-header">
                    <div class="tm-site-logo"></div>
                    <h1 class="pl-4 tm-site-title">Peri</h1>
                </header>
            </div>
        </div>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
                    <li class="nav-item active">
                        <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Posts</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="contact.html">Contact</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="row">
            <div class="col-lg-12">
                <div class="tm-video-container">
                    <video id="tm-welcome-video" class="tm-welcome-video" autoplay="" loop="" muted="">
                        <source src="videos/video.mp4" type="video/mp4"> Your browser does not support the video tag.
                        </video>
                    <div id="tm-video-loader"></div>
                    <div id="tm-video-text-overlay" class="tm-video-text-overlay d-none">
                        <h1>
                            <div id="rotate" class="tm-video-text">
                                <div>This is timeless</div>
                                <div>We are invincible</div>
                                <div>Quite unbeatable</div>
                                <div>and indestructible</div>
                            </div>
                        </h1>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <div class="container tm-container-2">
        <div class="row">
            <div class="col-lg-12">
                <!-- <h2 class="tm-welcome-text">Welcome to Timeless</h2> -->
                <h2 class="tm-welcome-text">EKS Preventive Control</h2>
                <br>
                <h3>Tools:</h3>
                <br>
                <h4>Amazon Elastic Kubernetes Services (EKS)</h4>
                <p>A fully managed service that helps customers run their Kubernetes clusters at scale by minimizing the efforts required to operate a Kubernetes control plane.Â </p>

                <h4>AWS Cloud Development Kit (CDK)</h4>
                <p>Infrastructure-as-code tool, including EKS cluster, Kubernetes workloads and a CI/CD pipeline. </p>

                <h4>Confest</h4>
                <p>An open-source tool within CNCF Open Policy Agent suite, to automate preventative controls before the deployment step.</p>

                <hr>
                <h3>Overview</h3>
                <p>The pipeline in this solution starts with a commit to the CodeCommit repo with the Kubernetes manifest files to be deployed onto EKS cluster. CodeBuild will then run Conftest prepackaged with control policies to validate the Kubernetes
                    manifest files. If any control policy is breached by the Kubernetes manifest files, CodeBuild will stop the process and prevent the Kubernetes manifest files from being deployed into the run-time environment. If all control policies
                    are satisfied by the Kubernetes manifest files, then the pipeline will pass the validation step and move on to deployment. The deployment step will provision an EKS cluster with an AWS managed worker node group then deploy the Kubernetes
                    manifests onto the EKS cluster.
                </p>

                <h3>Steps:</h3>
                <ol>
                    <li>Create a new empty AWS CodeCommit Repo that will be used by the CI/CD pipeline as the code source.</li>
                    <li>Download the blog source code from the AWS public repo and check into the empty CodeCommit repo created in step 1.</li>
                    <li>On the development terminal, run the CDK deploy command to provision the CI/CD pipeline.</li>
                    <li>Validate the Kubernetes validation step in the CI/CD pipeline stops the pipeline due to the Kubernetes manifests violating preventative control policies.</li>
                    <li>Fix the Kubernetes manifests and push the changes to CodeCommit repo. </li>
                    <li>Validate the CI/CD pipeline is triggered again and this time it passes the Kubernetes validation step.</li>
                    <li>Tick the manual approval step in the CI/CD pipeline.</li>
                    <li>Validate the pipeline successfully provisions an EKS cluster with Kubernetes manifests via CDK deploy.</li>
                </ol>

                <h4>1. Create a Repo</h4>
                <p>
                    Create a new empty AWS CodeCommit repo (following step 1 & 2 in <a href="https://docs.aws.amazon.com/codecommit/latest/userguide/getting-started.html">this</a> article) and git clone that empty repo to your development terminal.
                </p>
                <!-- <xmp>$ git clone codecommit::ap-southeast-2://cdk_auto_k8s_controls</xmp> -->

                <h4>2. Example Code</h4>
                <p>
                    On your development terminal, git clone the source code of this blog post from the example AWS code repo <a href="https://github.com/aws-samples/eks-preventative-controls">here</a>.
                </p>

                <h4>3. Move the Example Code to Your Empty Repo</h4>
                <p>Copy the source code of the blog post cloned in step 2 to the other local directory linked to the empty CodeCommit repo created in step 1 And then commit and push all the code</p>
                <!-- <xmp>git add .</xmp>
                    <xmp>$ git commit -m "push blog post source code to codecommit repo" $ git push</xmp> -->

                <h4>4. Configure</h4>
                <p>Configure the CDK context parameters that will be used to provision the pipeline:</p>
                <p>In cdk.json:</p>
                <xmp>(Set the pipelie name as you like)</xmp>
                <xmp> "pipeline-name": "EksDeployPipeline", </xmp>
                <xmp>(Verify the conftest-download-url as below)</xmp>
                <xmp> "conftest-download-url": "https://github.com/open-policy-agent/conftest/releases/download/v0.25.0/conftest_0.25.0_Linux_x86_64.tar.gz",</xmp>
                <xmp>(Set the repo name as the one you used in Step 1 described above)</xmp>
                <xmp>"codecommit-repo-name": "cdk_auto_k8s_controls"</xmp>

                <h4>
                    5. Deploy
                </h4>
                <p>Provision the CodePipeline instance in your AWS account.</p>
                <xmp>$ npx cdk deploy</xmp>

                <h4>6. Manifest</h4>

                <p>By now, we have successfully provisioned a CI/CD pipeline with embedded Kubernetes preventative control policies. Validation: Log onto the AWS Management Console and go to the CodePipeline service page, you should see a pipeline named
                    EksDeployPipeline as shown below:</p>
                <img src="img/initial_pipeline_run-698x1024.png" alt="initial_pipeline_run" width="700">

                <p>Looking into the "Details" why the pipline is failing, we can see that there are policy breach in Kubernetes. Hence, the CodeBuild step sets its BUILD state as FAILED and stops the pipeline from deploying the Kubernetes workloads into
                    runtime environment. </p>
                <p>In order to deploy the Kubernetes manifests, we need to fix those non-compliant issues:</p>
                <xmp>In k8s-manifests/guestbook-all-in-one.yaml </xmp>
                <xmp>At line 41, put "#" in front to comment out the line of "hostNetwork: true" </xmp>
                <xmp>In k8s-manifests/nginx.yaml:</xmp>
                <xmp>Uncomment out the line 7 of "env: prod" </xmp>

                <h4>7. Finish</h4>
                <p>Commit and push the changes. And remeber to approve it manualy!</p>
                <p>Then you will be able to build the pipeline successfully. </p>

                <img src="img/successful_deploy.png" alt="successful_deploy" width="700">
                <img src="img/successful_validation.png" alt="successful_validation" width="700">

                <p>Yeah! You've done it!ðŸ˜Š</p>
            </div>
        </div>
    </div>
    <hr>
    <!-- Footer -->
    <footer class="row mt-5 mb-5">
        <div class="col-lg-12">
            <p class="text-center tm-text-gray tm-copyright-text mb-0">Copyright &copy;
                <span class="tm-current-year">2022</span> Peri | Design: <a href="http://templatemo.com/tm-517-timeless" class="tm-text-white">Timeless</a>
            </p>

        </div>
    </footer>
    </div>
    <!-- .container -->

    <script src="js/jquery.min.js"></script>
    <!-- <script src="js/jquery-3.2.1.slim.min.js"></script> -->
    <script src="js/templatemo-script.js"></script>

</body>

</html>